<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Search for charity events by date, location, and category">
    <title>Search Charity Events - Find Your Perfect Volunteering Opportunity</title>
    
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="icon" type="image/x-icon" href="assets/icons/favicon.ico">
    
    <style>
        .hidden { display: none !important; }
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .search-highlight {
            background-color: #fff3cd;
            padding: 0.1em 0.2em;
            border-radius: 4px;
            font-weight: bold;
        }
        
        /* ‰øÆÂ§çbackdrop-filterÂÖºÂÆπÊÄß */
        .modal-overlay {
            -webkit-backdrop-filter: blur(4px);
            backdrop-filter: blur(4px);
        }
        .navbar.scrolled {
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body>
    <header>
        <nav class="navbar" role="navigation" aria-label="Main navigation">
            <div class="nav-container">
                <a href="index.html" class="nav-logo" aria-label="CharityEvents Home">
                    <span class="logo-icon">‚ù§Ô∏è</span>
                    CharityEvents
                </a>
                <ul class="nav-menu" role="menubar">
                    <li class="nav-item" role="none">
                        <a href="index.html" class="nav-link" role="menuitem">Home</a>
                    </li>
                    <li class="nav-item" role="none">
                        <a href="search.html" class="nav-link" role="menuitem" aria-current="page">Search Events</a>
                    </li>
                </ul>
            </div>
        </nav>
    </header>

    <main class="main-content" role="main">
        <!-- ÊêúÁ¥¢Âå∫Âüü -->
        <section class="search-section" aria-labelledby="search-heading">
            <div class="container">
                <div class="search-header">
                    <h1 id="search-heading" class="section-title">Find Charity Events</h1>
                    <p class="section-subtitle">Use the filters below to discover events that match your interests</p>
                </div>

                <!-- ÊêúÁ¥¢Ë°®Âçï -->
                <form id="search-form" class="search-form" role="search" aria-label="Search events">
                    <div class="form-grid">
                        <!-- Êó•ÊúüÁ≠õÈÄâ -->
                        <div class="form-group">
                            <label for="date-filter" class="form-label">Date</label>
                            <input 
                                type="date" 
                                id="date-filter" 
                                name="date"
                                aria-describedby="date-help"
                                class="form-input"
                            >
                            <small id="date-help" class="form-help">Filter events by specific date</small>
                        </div>

                        <!-- Âú∞ÁÇπÁ≠õÈÄâ -->
                        <div class="form-group">
                            <label for="location-filter" class="form-label">Location</label>
                            <input 
                                type="text" 
                                id="location-filter" 
                                name="location"
                                placeholder="Enter city or venue..."
                                aria-describedby="location-help"
                                class="form-input"
                            >
                            <small id="location-help" class="form-help">Search by city, park, or venue name</small>
                        </div>

                        <!-- ÂàÜÁ±ªÁ≠õÈÄâ -->
                        <div class="form-group">
                            <label for="category-filter" class="form-label">Category</label>
                            <select 
                                id="category-filter" 
                                name="category"
                                aria-describedby="category-help"
                                class="form-select"
                            >
                                <option value="">All Categories</option>
                                <!-- ÂàÜÁ±ªÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÂä†ËΩΩ -->
                            </select>
                            <small id="category-help" class="form-help">Choose a specific event type</small>
                        </div>
                    </div>

                    <!-- Ë°®ÂçïÊåâÈíÆ -->
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary" id="search-button">
                            Search Events
                        </button>
                        <button type="button" class="btn btn-secondary" id="clear-filters">
                            Clear Filters
                        </button>
                    </div>
                </form>
            </div>
        </section>

        <!-- ÊêúÁ¥¢ÁªìÊûúÂå∫Âüü -->
        <section class="results-section" aria-labelledby="results-heading">
            <div class="container">
                <div class="results-header">
                    <h2 id="results-heading" class="section-title">Search Results</h2>
                    <div id="results-summary" class="results-summary" aria-live="polite"></div>
                </div>

                <!-- Âä†ËΩΩÁä∂ÊÄÅ -->
                <div id="search-loading" class="loading-state hidden">
                    <div class="loading-spinner"></div>
                    <p>Searching for events...</p>
                </div>

                <!-- ÈîôËØØÁä∂ÊÄÅ -->
                <div id="search-error" class="error-state hidden" aria-live="assertive" role="alert">
                    <div class="error-icon">‚ö†Ô∏è</div>
                    <h3>Search Failed</h3>
                    <p id="search-error-message">We encountered an error while searching. Please try again.</p>
                    <button id="search-retry" class="btn btn-primary">Try Again</button>
                </div>

                <!-- Á©∫ÁªìÊûúÁä∂ÊÄÅ -->
                <div id="no-results" class="empty-state hidden">
                    <div class="empty-icon">üîç</div>
                    <h3>No Events Found</h3>
                    <p id="no-results-message">No events match your current filters. Try adjusting your search criteria.</p>
                    <button id="reset-search" class="btn btn-primary">Reset Filters</button>
                </div>

                <!-- ÊêúÁ¥¢ÁªìÊûúÂÆπÂô® -->
                <div id="search-results" class="events-grid hidden"></div>
            </div>
        </section>
    </main>

    <footer class="footer" role="contentinfo">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>CharityEvents</h3>
                    <p>Connecting people with meaningful charity opportunities since 2024.</p>
                </div>
                <div class="footer-section">
                    <h4>Quick Links</h4>
                    <ul class="footer-links">
                        <li><a href="index.html">Home</a></li>
                        <li><a href="search.html">Search Events</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Contact Us</h4>
                    <div class="contact-info">
                        <p>üìß Email: <a href="mailto:info@charityevents.org">info@charityevents.org</a></p>
                        <p>üìû Phone: <a href="tel:+15551234567">(555) 123-4567</a></p>
                        <p>üìç Address: 123 Charity Street, Hope City</p>
                    </div>
                </div>
                <div class="footer-section">
                    <h4>Follow Us</h4>
                    <div class="social-links">
                        <a href="#" aria-label="Facebook" class="social-link">üìò Facebook</a>
                        <a href="#" aria-label="Twitter" class="social-link">üê¶ Twitter</a>
                        <a href="#" aria-label="Instagram" class="social-link">üì∑ Instagram</a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 CharityEvents. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        // Â∑•ÂÖ∑ÂáΩÊï∞
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatCurrency(amount) {
            if (!amount) return '$0.00';
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }

        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', {
                    weekday: 'short',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return 'Invalid Date';
            }
        }

        function calculateProgress(current, total) {
            if (!total || total === 0) return 0;
            return Math.min(100, Math.round((current / total) * 100));
        }

        // Áä∂ÊÄÅÁÆ°ÁêÜ
        let categories = [];

        // Âä†ËΩΩÂàÜÁ±ªÊï∞ÊçÆ
        async function loadCategories() {
            try {
                console.log('üì• Loading categories...');
                const response = await fetch('http://localhost:3000/api/categories');
                const data = await response.json();
                
                if (data.success && data.data) {
                    categories = data.data;
                    populateCategoryFilter();
                }
            } catch (error) {
                console.error('‚ùå Failed to load categories:', error);
            }
        }

        // Â°´ÂÖÖÂàÜÁ±ªÁ≠õÈÄâÂô®
        function populateCategoryFilter() {
            const categoryFilter = document.getElementById('category-filter');
            if (categoryFilter && categories.length > 0) {
                const optionsHTML = categories.map(category => 
                    `<option value="${category.id}">${escapeHtml(category.name)}</option>`
                ).join('');
                categoryFilter.innerHTML = '<option value="">All Categories</option>' + optionsHTML;
            }
        }

        // ÊòæÁ§∫ÊêúÁ¥¢ÁªìÊûú
        function displaySearchResults(events, filters = {}) {
            console.log('üé® Displaying search results:', events);
            
            const container = document.getElementById('search-results');
            const loading = document.getElementById('search-loading');
            const error = document.getElementById('search-error');
            const empty = document.getElementById('no-results');
            const summary = document.getElementById('results-summary');
            
            // ÈöêËóèÂÖ∂‰ªñÁä∂ÊÄÅ
            if (loading) loading.classList.add('hidden');
            if (error) error.classList.add('hidden');
            if (empty) empty.classList.add('hidden');
            
            // Êõ¥Êñ∞ÁªìÊûúÊëòË¶Å
            if (summary) {
                const filterText = getFilterDescription(filters);
                const resultsCount = events.length;
                const summaryText = resultsCount === 1 
                    ? `1 event found${filterText}`
                    : `${resultsCount} events found${filterText}`;
                summary.textContent = summaryText;
            }
            
            if (events.length === 0) {
                if (empty) {
                    const message = getNoResultsMessage(filters);
                    document.getElementById('no-results-message').textContent = message;
                    empty.classList.remove('hidden');
                }
                return;
            }
            
            // ÊòæÁ§∫ÁªìÊûúÂÆπÂô®
            if (container) {
                container.classList.remove('hidden');
                
                // ÁîüÊàêÊ¥ªÂä®Âç°ÁâáHTML
                const eventsHTML = events.map(event => `
                    <div class="event-card">
                        <div class="event-card-header">
                            <span class="event-category">${escapeHtml(event.category_name || 'Uncategorized')}</span>
                            <span class="event-price">${formatCurrency(event.ticket_price)}</span>
                        </div>
                        
                        <h3 class="event-title">${escapeHtml(event.name)}</h3>
                        
                        <div class="event-meta">
                            <div class="event-date">
                                <span class="meta-icon">üìÖ</span>
                                <time>${formatDate(event.date_time)}</time>
                            </div>
                            
                            <div class="event-location">
                                <span class="meta-icon">üìç</span>
                                <span>${escapeHtml(event.location)}</span>
                            </div>
                        </div>
                        
                        <p class="event-description">${escapeHtml(event.short_description)}</p>
                        
                        ${event.goal_amount > 0 ? `
                        <div class="fundraising-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${calculateProgress(event.current_amount, event.goal_amount)}%"></div>
                            </div>
                            <div class="progress-text">
                                <span>${formatCurrency(event.current_amount)} raised</span>
                                <span>${calculateProgress(event.current_amount, event.goal_amount)}%</span>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="event-actions">
                            <button class="view-details-btn" onclick="window.location.href='event.html?id=${event.id}'">
                                View Details
                            </button>
                        </div>
                    </div>
                `).join('');
                
                container.innerHTML = eventsHTML;
            }
        }

        function getFilterDescription(filters) {
            const descriptions = [];
            
            if (filters.date) {
                const date = new Date(filters.date);
                descriptions.push(`on ${date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`);
            }
            
            if (filters.location) {
                descriptions.push(`in ${filters.location}`);
            }
            
            if (filters.category) {
                const category = categories.find(cat => cat.id == filters.category);
                if (category) {
                    descriptions.push(`in ${category.name} category`);
                }
            }
            
            return descriptions.length > 0 ? ` ${descriptions.join(' ')}` : '';
        }

        function getNoResultsMessage(filters) {
            const activeFilters = [];
            
            if (filters.date) activeFilters.push('date');
            if (filters.location) activeFilters.push('location');
            if (filters.category) {
                const category = categories.find(cat => cat.id == filters.category);
                activeFilters.push(category ? category.name : 'category');
            }
            
            if (activeFilters.length > 0) {
                return `No events found matching your current filters: ${activeFilters.join(', ')}. Try adjusting your search criteria.`;
            }
            
            return 'No events found matching your search criteria. Try adjusting your filters or search terms.';
        }

        function showSearchLoading() {
            const loading = document.getElementById('search-loading');
            const error = document.getElementById('search-error');
            const empty = document.getElementById('no-results');
            const results = document.getElementById('search-results');
            
            if (loading) loading.classList.remove('hidden');
            if (error) error.classList.add('hidden');
            if (empty) empty.classList.add('hidden');
            if (results) results.classList.add('hidden');
        }

        function showSearchError(error) {
            const loading = document.getElementById('search-loading');
            const errorDiv = document.getElementById('search-error');
            
            if (loading) loading.classList.add('hidden');
            if (errorDiv) {
                document.getElementById('search-error-message').textContent = 
                    error.message || 'We encountered an error while searching. Please try again.';
                errorDiv.classList.remove('hidden');
            }
        }

        // ÊêúÁ¥¢ÂáΩÊï∞ - ‰øÆÂ§çÁâàÊú¨
        async function performSearch(filters = {}) {
            console.log('üîç Performing search with filters:', filters);
            showSearchLoading();
            
            try {
                // ÊñπÊ≥ï1: ‰ΩøÁî®ÊêúÁ¥¢Á´ØÁÇπ
                let url = 'http://localhost:3000/api/events/search';
                const params = new URLSearchParams();
                
                if (filters.date) params.append('date', filters.date);
                if (filters.location) params.append('location', filters.location);
                if (filters.category) params.append('category', filters.category);
                
                const queryString = params.toString();
                if (queryString) {
                    url += '?' + queryString;
                }
                
                console.log('üåê Searching:', url);
                
                const response = await fetch(url);
                if (!response.ok) {
                    // Â¶ÇÊûúÊêúÁ¥¢Á´ØÁÇπÂ§±Ë¥•ÔºåÂ∞ùËØïÂ§áÁî®ÊñπÊ°à
                    console.log('üîÑ Search endpoint failed, trying client-side filtering');
                    throw new Error(`Search endpoint returned ${response.status}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ Search results from API:', data);
                
                // Â§ÑÁêÜ‰∏çÂêåÁöÑÂìçÂ∫îÊ†ºÂºè
                const events = data.data || data || [];
                displaySearchResults(events, filters);
                
            } catch (error) {
                console.error('‚ùå Search API failed, trying alternative method:', error);
                
                // Â§áÁî®ÊñπÊ°àÔºöËé∑ÂèñÊâÄÊúâ‰∫ã‰ª∂ÁÑ∂ÂêéÂú®ÂÆ¢Êà∑Á´ØÁ≠õÈÄâ
                try {
                    await performClientSideSearch(filters);
                } catch (fallbackError) {
                    console.error('‚ùå Fallback search also failed:', fallbackError);
                    showSearchError(error);
                }
            }
        }

        // Â§áÁî®ÊñπÊ°àÔºöÂÆ¢Êà∑Á´ØÊêúÁ¥¢
        async function performClientSideSearch(filters = {}) {
            console.log('üîÑ Using client-side search as fallback');
            
            try {
                // Ëé∑ÂèñÊâÄÊúâ‰∫ã‰ª∂
                const response = await fetch('http://localhost:3000/api/events');
                if (!response.ok) {
                    throw new Error(`Failed to fetch events: ${response.status}`);
                }
                
                const data = await response.json();
                const allEvents = data.data || data || [];
                
                console.log('üìä Total events for client-side filtering:', allEvents.length);
                
                // Âú®ÂÆ¢Êà∑Á´ØËøõË°åÁ≠õÈÄâ
                let filteredEvents = allEvents.filter(event => {
                    let matches = true;
                    
                    // Êó•ÊúüÁ≠õÈÄâ
                    if (filters.date) {
                        const eventDate = new Date(event.date_time).toISOString().split('T')[0];
                        matches = matches && (eventDate === filters.date);
                    }
                    
                    // Âú∞ÁÇπÁ≠õÈÄâ
                    if (filters.location) {
                        const searchLocation = filters.location.toLowerCase();
                        const eventLocation = event.location.toLowerCase();
                        const eventName = event.name.toLowerCase();
                        matches = matches && (
                            eventLocation.includes(searchLocation) || 
                            eventName.includes(searchLocation)
                        );
                    }
                    
                    // ÂàÜÁ±ªÁ≠õÈÄâ
                    if (filters.category) {
                        matches = matches && (event.category_id == filters.category);
                    }
                    
                    return matches;
                });
                
                console.log('‚úÖ Client-side filtered events:', filteredEvents.length);
                displaySearchResults(filteredEvents, filters);
                
            } catch (error) {
                throw new Error(`Client-side search failed: ${error.message}`);
            }
        }

        // Ê∏ÖÈô§Á≠õÈÄâÂô®
        function clearFilters() {
            document.getElementById('search-form').reset();
            document.getElementById('search-results').classList.add('hidden');
            document.getElementById('results-summary').textContent = '';
            document.getElementById('no-results').classList.add('hidden');
            document.getElementById('search-error').classList.add('hidden');
        }

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÊâßË°å
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîç Search page loaded');
            
            // Âä†ËΩΩÂàÜÁ±ªÊï∞ÊçÆ
            loadCategories();
            
            // ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
            const searchForm = document.getElementById('search-form');
            const clearButton = document.getElementById('clear-filters');
            const retryButton = document.getElementById('search-retry');
            const resetButton = document.getElementById('reset-search');
            
            if (searchForm) {
                searchForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const filters = {
                        date: document.getElementById('date-filter').value,
                        location: document.getElementById('location-filter').value,
                        category: document.getElementById('category-filter').value
                    };
                    
                    performSearch(filters);
                });
            }
            
            if (clearButton) {
                clearButton.addEventListener('click', clearFilters);
            }
            
            if (retryButton) {
                retryButton.addEventListener('click', function() {
                    const filters = {
                        date: document.getElementById('date-filter').value,
                        location: document.getElementById('location-filter').value,
                        category: document.getElementById('category-filter').value
                    };
                    performSearch(filters);
                });
            }
            
            if (resetButton) {
                resetButton.addEventListener('click', clearFilters);
            }
        });
    </script>
</body>
</html>